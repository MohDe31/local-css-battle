<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/rate/style.css" />
    <title>Document</title>
  </head>
  <body>
    <table>
      <thead>
        <th class="cls">Rank</th>
        <th>Username</th>
        <th>Result</th>
      </thead>
      <tbody></tbody>
    </table>
  </body>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const table = document.querySelector("table");

    let submited_users = [];

    function insertToTable(rank, username, score) {
      const row = table.tBodies[0].insertRow();
      const cell1 = row.insertCell(0);
      cell1.className = "cls";
      cell1.append(rank);
      const cell2 = row.insertCell(1);
      cell2.append(username);
      const cell3 = row.insertCell(2);
      cell3.append(`${score.toFixed(2)}%`);
    }

    function renderResults() {
      table.tBodies[0].innerHTML = "";
      submited_users.forEach((user, index) => {
        insertToTable(index + 1, user.uname, user.percentage);
      });
    }

    function sortResults() {
      return submited_users.sort((a, b) => {
        if (a.percentage > b.percentage) {
          return -1;
        }

        if (a.percentage === b.percentage) {
          return 0;
        }

        if (a.percentage < b.percentage) {
          return 1;
        }
      });
    }

    fetch("submited").then(async (res) => {
      const json = await res.json();
      submited_users = json.users_submitted;
      sortResults();
      renderResults();
    });

    socket.on("submit", (username) => {
      submited_users.push(username);
      sortResults();
      renderResults();
    });
  </script>
</html>
